<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Business ERP</title>
<style>
:root{--bg:#0f172a;--surface:#1e293b;--surface2:#334155;--border:#475569;--text:#e2e8f0;--text2:#94a3b8;--blue:#3b82f6;--purple:#8b5cf6;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--orange:#f97316;--cyan:#06b6d4}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
/* NAV */
.topbar{background:var(--surface);border-bottom:1px solid var(--surface2);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar-left{display:flex;align-items:center;gap:24px}
.topbar-left h1{font-size:18px;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav-tabs{display:flex;gap:4px}
.nav-tab{padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text2);transition:all .2s;border:none;background:none}
.nav-tab:hover{color:var(--text);background:var(--surface2)}
.nav-tab.active{color:#fff;background:var(--blue)}
.topbar-right{display:flex;align-items:center;gap:12px}
.user-badge{padding:6px 12px;border-radius:6px;background:var(--surface2);font-size:12px;color:var(--text2)}
.btn-logout{padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text2);cursor:pointer;font-size:12px}
.btn-logout:hover{border-color:var(--red);color:var(--red)}

/* VIEWS */
.view{display:none;padding:24px;max-width:1600px;margin:0 auto}
.view.active{display:block}

/* BIRD'S EYE */
.domain-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:24px}
.domain-card{background:var(--surface);border-radius:12px;padding:24px;border:1px solid var(--surface2);cursor:pointer;transition:all .2s}
.domain-card:hover{border-color:var(--blue);transform:translateY(-2px)}
.domain-card h3{font-size:18px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.domain-card .icon{font-size:24px}
.domain-metrics{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.metric{background:var(--bg);border-radius:8px;padding:12px}
.metric .value{font-size:24px;font-weight:700}
.metric .label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.metric.danger .value{color:var(--red)}
.metric.success .value{color:var(--green)}
.metric.warning .value{color:var(--yellow)}

/* STAT ROW */
.stat-row{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap}
.stat-box{background:var(--surface);border-radius:10px;padding:16px 20px;flex:1;min-width:180px;border:1px solid var(--surface2)}
.stat-box .val{font-size:28px;font-weight:700}
.stat-box .lbl{font-size:12px;color:var(--text2)}

/* DOMAIN DETAIL */
.domain-detail{margin-top:20px}
.domain-detail h2{margin-bottom:16px;display:flex;align-items:center;gap:12px}
.back-btn{padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text);cursor:pointer;font-size:13px}
.back-btn:hover{border-color:var(--blue);color:var(--blue)}

/* TABLES */
.data-table{width:100%;border-collapse:collapse;background:var(--surface);border-radius:10px;overflow:hidden}
.data-table th{background:var(--bg);padding:10px 14px;text-align:left;font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;font-weight:600;border-bottom:1px solid var(--surface2)}
.data-table td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--surface2)}
.data-table tr:hover td{background:rgba(59,130,246,.05)}
.data-table tr:last-child td{border-bottom:none}

/* BADGES */
.badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-green{background:rgba(34,197,94,.15);color:var(--green)}
.badge-yellow{background:rgba(234,179,8,.15);color:var(--yellow)}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
.badge-blue{background:rgba(59,130,246,.15);color:var(--blue)}
.badge-purple{background:rgba(139,92,246,.15);color:var(--purple)}
.badge-gray{background:rgba(148,163,184,.15);color:var(--text2)}
.badge-orange{background:rgba(249,115,22,.15);color:var(--orange)}

/* PROGRESS */
.progress-bar{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;border-radius:3px;transition:width .3s}

/* JOURNEY MAP */
.journey-container{margin-top:20px}
.journey-header{display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.journey-entity{background:var(--surface);border-radius:10px;padding:16px 20px;border:1px solid var(--surface2)}
.journey-entity h3{font-size:16px;margin-bottom:4px}
.journey-entity p{font-size:13px;color:var(--text2)}
.timeline{display:flex;gap:0;overflow-x:auto;padding:20px 0;position:relative}
.timeline::before{content:'';position:absolute;top:50%;left:0;right:0;height:2px;background:var(--surface2)}
.stage{position:relative;flex:0 0 200px;text-align:center;padding-top:60px}
.stage-dot{width:32px;height:32px;border-radius:50%;position:absolute;top:38px;left:50%;transform:translateX(-50%);border:3px solid var(--surface2);background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:14px;z-index:2}
.stage-dot.completed{background:var(--green);border-color:var(--green)}
.stage-dot.active{background:var(--blue);border-color:var(--blue);animation:pulse 2s infinite}
.stage-dot.overdue{background:var(--red);border-color:var(--red)}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.4)}50%{box-shadow:0 0 0 8px rgba(59,130,246,0)}}
.stage-card{background:var(--surface);border:1px solid var(--surface2);border-radius:8px;padding:12px;margin:12px 8px 0;text-align:left}
.stage-card h4{font-size:13px;margin-bottom:6px}
.stage-card .assignee{font-size:11px;color:var(--text2)}
.stage-card .sla{font-size:11px;margin-top:4px}

/* ACTIVITY FEED */
.activity-feed{margin-top:24px;background:var(--surface);border-radius:10px;padding:20px;border:1px solid var(--surface2)}
.activity-feed h3{margin-bottom:12px;font-size:15px}
.activity-item{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid var(--surface2);font-size:13px}
.activity-item:last-child{border-bottom:none}
.activity-time{color:var(--text2);font-size:11px;min-width:80px}
.activity-action{flex:1}

/* MY TASKS */
.tasks-controls{display:flex;gap:12px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
.tasks-controls select,.tasks-controls input{padding:8px 12px;border-radius:6px;border:1px solid var(--surface2);background:var(--surface);color:var(--text);font-size:13px}
.toggle-group{display:flex;border-radius:6px;overflow:hidden;border:1px solid var(--surface2)}
.toggle-btn{padding:8px 16px;border:none;background:var(--surface);color:var(--text2);cursor:pointer;font-size:13px}
.toggle-btn.active{background:var(--blue);color:#fff}

/* KANBAN */
.kanban{display:flex;gap:16px;overflow-x:auto;padding-bottom:20px}
.kanban-col{flex:0 0 280px;background:var(--surface);border-radius:10px;border:1px solid var(--surface2)}
.kanban-col-header{padding:12px 16px;font-size:13px;font-weight:600;border-bottom:1px solid var(--surface2);display:flex;justify-content:space-between;align-items:center}
.kanban-col-header .count{background:var(--surface2);padding:2px 8px;border-radius:10px;font-size:11px}
.kanban-cards{padding:8px;max-height:calc(100vh - 280px);overflow-y:auto}
.kanban-card{background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px;border:1px solid var(--surface2);cursor:pointer;transition:border-color .2s}
.kanban-card:hover{border-color:var(--blue)}
.kanban-card h4{font-size:13px;margin-bottom:6px}
.kanban-card .meta{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--text2)}

/* TASK LIST */
.task-list-item{display:flex;align-items:center;gap:16px;padding:14px 16px;background:var(--surface);border-radius:8px;margin-bottom:8px;border:1px solid var(--surface2);cursor:pointer;transition:border-color .2s}
.task-list-item:hover{border-color:var(--blue)}
.task-priority{width:4px;height:36px;border-radius:2px;flex-shrink:0}
.task-priority.urgent{background:var(--red)}
.task-priority.high{background:var(--orange)}
.task-priority.medium{background:var(--blue)}
.task-priority.low{background:var(--text2)}
.task-info{flex:1;min-width:0}
.task-info h4{font-size:14px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.task-info .sub{font-size:12px;color:var(--text2)}
.task-deadline{text-align:right;min-width:80px}
.task-deadline .countdown{font-size:14px;font-weight:600}
.task-deadline .date{font-size:11px;color:var(--text2)}
.task-steps{min-width:100px;text-align:center}
.task-steps .frac{font-size:13px}

/* PERSONAL STATS */
.personal-stats{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap}
.p-stat{background:var(--surface);border-radius:10px;padding:16px 20px;flex:1;min-width:140px;text-align:center;border:1px solid var(--surface2)}
.p-stat .val{font-size:24px;font-weight:700}
.p-stat .lbl{font-size:11px;color:var(--text2)}

/* MODALS */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border-radius:12px;padding:24px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;border:1px solid var(--surface2)}
.modal h2{margin-bottom:16px;font-size:18px}
.modal-close{float:right;background:none;border:none;color:var(--text2);cursor:pointer;font-size:20px;padding:4px 8px}
.modal-close:hover{color:var(--text)}
.form-row{margin-bottom:14px}
.form-row label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px;font-weight:500}
.form-row input,.form-row select,.form-row textarea{width:100%;padding:10px 12px;border-radius:6px;border:1px solid var(--surface2);background:var(--bg);color:var(--text);font-size:13px}
.form-row textarea{min-height:80px;resize:vertical}
.btn{padding:10px 20px;border-radius:6px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:opacity .2s}
.btn:hover{opacity:.85}
.btn-primary{background:var(--blue);color:#fff}
.btn-success{background:var(--green);color:#fff}
.btn-danger{background:var(--red);color:#fff}
.btn-secondary{background:var(--surface2);color:var(--text)}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-group{display:flex;gap:8px;margin-top:16px}

/* CHECKLIST */
.checklist{list-style:none}
.checklist li{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--surface2);font-size:13px}
.checklist li:last-child{border-bottom:none}
.check-btn{width:22px;height:22px;border-radius:4px;border:2px solid var(--surface2);background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:transparent;font-size:14px;flex-shrink:0}
.check-btn.done{background:var(--green);border-color:var(--green);color:#fff}

/* ADMIN TABS */
.admin-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.admin-tab{padding:8px 16px;border-radius:6px;border:1px solid var(--surface2);background:none;color:var(--text2);cursor:pointer;font-size:13px}
.admin-tab.active{border-color:var(--purple);color:var(--purple);background:rgba(139,92,246,.1)}

/* RESPONSIVE */
@media(max-width:768px){.domain-grid{grid-template-columns:1fr}.kanban{flex-direction:column}.kanban-col{flex:none;width:100%}.timeline{flex-direction:column}.stage{flex:none;padding-top:0;text-align:left;padding-left:40px;margin-bottom:12px}.stage-dot{left:0;top:0;transform:none}.stage-card{margin:0}}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:3px}
.hidden{display:none!important}
.clickable{cursor:pointer}
.text-center{text-align:center}
.mt-8{margin-top:8px}
.mt-16{margin-top:16px}
.mb-16{margin-bottom:16px}
.flex{display:flex}
.gap-8{gap:8px}
.flex-1{flex:1}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div class="topbar-left">
        <h1>Business ERP</h1>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('birdseye')">Bird's Eye</button>
            <button class="nav-tab" onclick="showView('mytasks')">My Tasks</button>
            <button class="nav-tab" onclick="showView('admin')" id="adminTab">Admin</button>
        </div>
    </div>
    <div class="topbar-right">
        <span class="user-badge" id="userBadge"></span>
        <button class="btn-logout" onclick="logout()">Sign Out</button>
    </div>
</div>

<!-- ========== BIRD'S EYE VIEW ========== -->
<div class="view active" id="view-birdseye">
    <div id="birdseyeMain">
        <h2 style="margin-bottom:20px">War Room</h2>
        <div class="stat-row" id="globalStats"></div>
        <div class="domain-grid" id="domainCards"></div>
        <div style="margin-top:24px">
            <h3 style="margin-bottom:12px">Recent Activity</h3>
            <div id="recentActivity"></div>
        </div>
    </div>
    <div id="domainDetail" class="hidden">
        <div class="domain-detail">
            <h2><button class="back-btn" onclick="showBirdsEye()">&larr; Back</button> <span id="domainDetailTitle"></span></h2>
            <div class="stat-row" id="domainDetailStats"></div>
            <h3 style="margin:16px 0 8px">Active Tasks</h3>
            <table class="data-table" id="domainTasksTable">
                <thead><tr><th>Task</th><th>Assignee</th><th>Status</th><th>Priority</th><th>Deadline</th><th>Progress</th></tr></thead>
                <tbody></tbody>
            </table>
            <h3 style="margin:24px 0 8px">Active Workflows</h3>
            <table class="data-table" id="domainWorkflowsTable">
                <thead><tr><th>Workflow</th><th>Entity</th><th>Stage</th><th>Status</th><th>Started</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div id="journeyDetail" class="hidden">
        <div class="journey-container">
            <div class="journey-header">
                <button class="back-btn" onclick="backFromJourney()">&larr; Back</button>
                <div class="journey-entity" id="journeyEntity"></div>
            </div>
            <div class="timeline" id="journeyTimeline"></div>
            <div class="activity-feed" id="journeyActivity">
                <h3>Activity Feed</h3>
                <div id="journeyActivityList"></div>
            </div>
        </div>
    </div>
</div>

<!-- ========== MY TASKS VIEW ========== -->
<div class="view" id="view-mytasks">
    <div class="personal-stats" id="personalStats"></div>
    <div class="tasks-controls">
        <div class="toggle-group">
            <button class="toggle-btn active" onclick="setTaskView('list',this)">List</button>
            <button class="toggle-btn" onclick="setTaskView('kanban',this)">Kanban</button>
        </div>
        <select id="taskDomainFilter" onchange="loadMyTasks()">
            <option value="">All Domains</option>
            <option value="sales">Sales</option>
            <option value="circuits">Circuits</option>
            <option value="marketing">Marketing</option>
            <option value="hr">HR</option>
        </select>
        <select id="taskStatusFilter" onchange="loadMyTasks()">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="assigned">Assigned</option>
            <option value="in_progress">In Progress</option>
            <option value="overdue">Overdue</option>
            <option value="completed">Completed</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="openCreateTask()">+ New Task</button>
    </div>
    <div id="taskListView"></div>
    <div id="taskKanbanView" class="hidden"></div>
</div>

<!-- ========== ADMIN VIEW ========== -->
<div class="view" id="view-admin">
    <div class="admin-tabs">
        <button class="admin-tab active" onclick="showAdminSection('templates',this)">Templates</button>
        <button class="admin-tab" onclick="showAdminSection('workflows',this)">Workflows</button>
        <button class="admin-tab" onclick="showAdminSection('penalties',this)">Penalties</button>
        <button class="admin-tab" onclick="showAdminSection('startWf',this)">Start Workflow</button>
        <button class="admin-tab" onclick="showAdminSection('notifications',this)">Notifications</button>
        <button class="admin-tab" onclick="showAdminSection('leaderboard',this)">Leaderboard</button>
    </div>
    <div id="adminSection-templates">
        <div class="flex gap-8 mb-16">
            <select id="templateDomainFilter" onchange="loadTemplates()">
                <option value="">All Domains</option>
                <option value="sales">Sales</option>
                <option value="circuits">Circuits</option>
                <option value="marketing">Marketing</option>
                <option value="hr">HR</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="openCreateTemplate()">+ New Template</button>
        </div>
        <table class="data-table" id="templatesTable">
            <thead><tr><th>Name</th><th>Domain</th><th>SLA</th><th>Priority</th><th>Steps</th><th>Assignee Rule</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="adminSection-workflows" class="hidden">
        <table class="data-table" id="workflowDefsTable">
            <thead><tr><th>Name</th><th>Domain</th><th>Trigger</th><th>Stages</th><th>Description</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="adminSection-penalties" class="hidden">
        <div class="flex gap-8 mb-16">
            <select id="penaltyStatusFilter" onchange="loadPenalties()">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="waived">Waived</option>
            </select>
        </div>
        <table class="data-table" id="penaltiesTable">
            <thead><tr><th>Employee</th><th>Task</th><th>Type</th><th>Amount (SAR)</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="adminSection-startWf" class="hidden">
        <div style="max-width:600px">
            <h3 class="mb-16">Start New Workflow</h3>
            <div class="form-row">
                <label>Workflow Definition</label>
                <select id="startWfDef"></select>
            </div>
            <div class="form-row">
                <label>Entity Type</label>
                <select id="startWfEntityType" onchange="loadEntities()">
                    <option value="circuit">Circuit</option>
                    <option value="lead">CRM Lead</option>
                    <option value="employee">Employee</option>
                    <option value="campaign">Campaign</option>
                </select>
            </div>
            <div class="form-row">
                <label>Entity</label>
                <select id="startWfEntity"></select>
            </div>
            <button class="btn btn-primary" onclick="startWorkflow()">Start Workflow</button>
            <div id="startWfResult" class="mt-16"></div>
        </div>
    </div>
    <div id="adminSection-notifications" class="hidden">
        <table class="data-table" id="notificationsTable">
            <thead><tr><th>Time</th><th>Recipient</th><th>Type</th><th>Message</th><th>Status</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="adminSection-leaderboard" class="hidden">
        <table class="data-table" id="leaderboardTable">
            <thead><tr><th>#</th><th>Employee</th><th>Completed</th><th>On-Time %</th><th>Streak</th><th>Avg Hours</th><th>Penalties (SAR)</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- TASK DETAIL MODAL -->
<div class="modal-overlay" id="taskModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
        <h2 id="taskModalTitle"></h2>
        <div id="taskModalBody"></div>
    </div>
</div>

<!-- CREATE TASK MODAL -->
<div class="modal-overlay" id="createTaskModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('createTaskModal')">&times;</button>
        <h2>Create Task</h2>
        <div class="form-row"><label>Title</label><input id="ctTitle"></div>
        <div class="form-row"><label>Description</label><textarea id="ctDesc"></textarea></div>
        <div class="form-row"><label>Domain</label>
            <select id="ctDomain"><option value="sales">Sales</option><option value="circuits">Circuits</option><option value="marketing">Marketing</option><option value="hr">HR</option></select>
        </div>
        <div class="form-row"><label>Priority</label>
            <select id="ctPriority"><option value="medium">Medium</option><option value="low">Low</option><option value="high">High</option><option value="urgent">Urgent</option></select>
        </div>
        <div class="form-row"><label>SLA (hours)</label><input type="number" id="ctSLA" value="24"></div>
        <div class="form-row"><label>Assign To (Employee)</label><select id="ctAssignee"><option value="">-- Unassigned --</option></select></div>
        <div class="form-row"><label>Steps (one per line)</label><textarea id="ctSteps" placeholder="Step 1&#10;Step 2&#10;Step 3"></textarea></div>
        <div class="btn-group"><button class="btn btn-primary" onclick="createTask()">Create Task</button></div>
    </div>
</div>

<!-- CREATE TEMPLATE MODAL -->
<div class="modal-overlay" id="createTemplateModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('createTemplateModal')">&times;</button>
        <h2>Create Template</h2>
        <div class="form-row"><label>Name</label><input id="tplName"></div>
        <div class="form-row"><label>Description</label><textarea id="tplDesc"></textarea></div>
        <div class="form-row"><label>Domain</label>
            <select id="tplDomain"><option value="sales">Sales</option><option value="circuits">Circuits</option><option value="marketing">Marketing</option><option value="hr">HR</option></select>
        </div>
        <div class="form-row"><label>Default SLA (hours)</label><input type="number" id="tplSLA" value="24"></div>
        <div class="form-row"><label>Priority</label>
            <select id="tplPriority"><option value="medium">Medium</option><option value="low">Low</option><option value="high">High</option><option value="urgent">Urgent</option></select>
        </div>
        <div class="form-row"><label>Assignee Rule</label>
            <select id="tplAssigneeRule"><option value="manual">Manual</option><option value="department">By Department</option><option value="role">By Role</option><option value="round-robin">Round Robin</option></select>
        </div>
        <div class="form-row"><label>Department (if by department)</label><input id="tplDept"></div>
        <div class="form-row"><label>Steps (one per line)</label><textarea id="tplSteps" placeholder="Step 1&#10;Step 2&#10;Step 3"></textarea></div>
        <div class="btn-group"><button class="btn btn-primary" onclick="createTemplate()">Create Template</button></div>
    </div>
</div>

<script>
// ==================== GLOBALS ====================
let currentUser = null;
let currentView = 'birdseye';
let taskViewMode = 'list';
let journeyPrevView = 'birdseye'; // track where journey was opened from

// ==================== INIT ====================
async function init() {
    try {
        const res = await fetch('/api/auth/me');
        if (res.status === 401) { window.location.href = '/login.html'; return; }
        currentUser = await res.json();
        document.getElementById('userBadge').textContent = `${currentUser.display_name} (${currentUser.role})`;
        if (!currentUser.isManager) {
            document.getElementById('adminTab').classList.add('hidden');
        }
        loadBirdsEye();
    } catch (e) { window.location.href = '/login.html'; }
}

async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/login.html';
}

// ==================== VIEW NAVIGATION ====================
function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('view-' + name).classList.add('active');
    event.target.classList.add('active');
    currentView = name;
    if (name === 'birdseye') loadBirdsEye();
    else if (name === 'mytasks') { loadMyTasks(); loadPersonalStats(); }
    else if (name === 'admin') { loadTemplates(); loadWorkflowDefs(); }
}

// ==================== BIRD'S EYE ====================
async function loadBirdsEye() {
    document.getElementById('birdseyeMain').classList.remove('hidden');
    document.getElementById('domainDetail').classList.add('hidden');
    document.getElementById('journeyDetail').classList.add('hidden');

    const [stats, entityCounts, activity] = await Promise.all([
        api('/api/dashboard/stats'),
        api('/api/dashboard/entity-counts'),
        api('/api/dashboard/activity?limit=15')
    ]);

    // Global stats
    const totalActive = Object.values(stats).reduce((a,s) => a + s.active, 0);
    const totalOverdue = Object.values(stats).reduce((a,s) => a + s.overdue, 0);
    const totalCompleted = Object.values(stats).reduce((a,s) => a + s.completed, 0);
    document.getElementById('globalStats').innerHTML = `
        <div class="stat-box"><div class="val">${totalActive}</div><div class="lbl">Active Tasks</div></div>
        <div class="stat-box"><div class="val" style="color:var(--red)">${totalOverdue}</div><div class="lbl">Overdue</div></div>
        <div class="stat-box"><div class="val" style="color:var(--green)">${totalCompleted}</div><div class="lbl">Completed</div></div>
        <div class="stat-box"><div class="val">${entityCounts.circuits || 0}</div><div class="lbl">Circuits</div></div>
        <div class="stat-box"><div class="val">${entityCounts.leads || 0}</div><div class="lbl">CRM Leads</div></div>
        <div class="stat-box"><div class="val">${entityCounts.employees || 0}</div><div class="lbl">Employees</div></div>
    `;

    // Domain cards
    const icons = { sales: 'ðŸ’°', circuits: 'ðŸ”Œ', marketing: 'ðŸ“¢', hr: 'ðŸ‘¥' };
    const labels = { sales: 'Sales (CRM)', circuits: 'Circuits (L3+DSP)', marketing: 'Marketing', hr: 'HR' };
    document.getElementById('domainCards').innerHTML = Object.entries(stats).map(([domain, s]) => `
        <div class="domain-card" onclick="showDomainDetail('${domain}')">
            <h3><span class="icon">${icons[domain]}</span> ${labels[domain]}</h3>
            <div class="domain-metrics">
                <div class="metric"><div class="value">${s.active}</div><div class="label">Active</div></div>
                <div class="metric danger"><div class="value">${s.overdue}</div><div class="label">Overdue</div></div>
                <div class="metric success"><div class="value">${s.completion_rate}%</div><div class="label">Completion</div></div>
                <div class="metric warning"><div class="value">${s.revenue_at_risk > 0 ? (s.revenue_at_risk/1000).toFixed(0)+'K' : '0'}</div><div class="label">SAR at Risk</div></div>
            </div>
        </div>
    `).join('');

    // Recent activity
    document.getElementById('recentActivity').innerHTML = (activity || []).slice(0,10).map(a => `
        <div class="activity-item">
            <span class="activity-time">${timeAgo(a.created_at)}</span>
            <span class="activity-action"><strong>${a.actor_name || 'System'}</strong> ${a.action} <em>${a.task_title}</em> <span class="badge badge-blue">${a.domain}</span></span>
        </div>
    `).join('') || '<p style="color:var(--text2);padding:12px">No recent activity</p>';
}

async function showDomainDetail(domain) {
    document.getElementById('birdseyeMain').classList.add('hidden');
    document.getElementById('domainDetail').classList.remove('hidden');
    document.getElementById('journeyDetail').classList.add('hidden');

    const labels = { sales: 'Sales', circuits: 'Circuits', marketing: 'Marketing', hr: 'HR' };
    document.getElementById('domainDetailTitle').textContent = labels[domain];

    const data = await api(`/api/dashboard/domain/${domain}`);

    document.getElementById('domainDetailStats').innerHTML = `
        <div class="stat-box"><div class="val">${data.tasks.length}</div><div class="lbl">Active Tasks</div></div>
        <div class="stat-box"><div class="val" style="color:var(--red)">${data.overdueTasks.length}</div><div class="lbl">Overdue</div></div>
        <div class="stat-box"><div class="val">${data.workflows.length}</div><div class="lbl">Active Workflows</div></div>
    `;

    // Tasks table
    const tbody = document.querySelector('#domainTasksTable tbody');
    tbody.innerHTML = data.tasks.map(t => `
        <tr class="clickable" onclick="openTaskDetail(${t.id})">
            <td>${esc(t.title)}</td>
            <td>${esc(t.assignee_name || 'Unassigned')}</td>
            <td>${statusBadge(t.status)}</td>
            <td>${priorityBadge(t.priority)}</td>
            <td>${t.deadline ? deadlineDisplay(t.deadline) : '-'}</td>
            <td><div class="progress-bar" style="width:80px"><div class="progress-fill" style="width:${t.steps_total?Math.round(t.steps_completed/t.steps_total*100):0}%;background:var(--green)"></div></div> ${t.steps_completed}/${t.steps_total}</td>
        </tr>
    `).join('') || '<tr><td colspan="6" class="text-center" style="padding:20px;color:var(--text2)">No tasks</td></tr>';

    // Workflows table
    const wfBody = document.querySelector('#domainWorkflowsTable tbody');
    wfBody.innerHTML = data.workflows.map(w => `
        <tr class="clickable" onclick="showJourneyMap(${w.id})">
            <td>${esc(w.workflow_name)}</td>
            <td>${esc(w.entity_name || w.entity_id || '-')}</td>
            <td>Stage ${w.current_stage}</td>
            <td>${statusBadge(w.status)}</td>
            <td>${formatDate(w.started_at)}</td>
        </tr>
    `).join('') || '<tr><td colspan="5" class="text-center" style="padding:20px;color:var(--text2)">No workflows</td></tr>';
}

function showBirdsEye() {
    document.getElementById('birdseyeMain').classList.remove('hidden');
    document.getElementById('domainDetail').classList.add('hidden');
    document.getElementById('journeyDetail').classList.add('hidden');
}

// ==================== JOURNEY MAP ====================
async function showJourneyMap(instanceId) {
    journeyPrevView = document.getElementById('domainDetail').classList.contains('hidden') ? 'main' : 'domain';
    document.getElementById('birdseyeMain').classList.add('hidden');
    document.getElementById('domainDetail').classList.add('hidden');
    document.getElementById('journeyDetail').classList.remove('hidden');

    const data = await api(`/api/workflows/instances/${instanceId}`);
    if (!data) return;

    document.getElementById('journeyEntity').innerHTML = `
        <h3>${esc(data.workflow_name)}</h3>
        <p>${esc(data.entity_type || '')} : ${esc(data.entity_name || data.entity_id || 'N/A')} | Status: ${statusBadge(data.status)} | Started: ${formatDate(data.started_at)}</p>
    `;

    const stages = data.definition_stages || [];
    const tasks = data.tasks || [];

    document.getElementById('journeyTimeline').innerHTML = stages.map(stage => {
        const task = tasks.find(t => t.stage_order === stage.order);
        const dot = task ? (task.status === 'completed' ? 'completed' : (task.status === 'overdue' ? 'overdue' : 'active')) : '';
        const symbol = task ? (task.status === 'completed' ? 'âœ“' : (task.status === 'overdue' ? '!' : stage.order)) : stage.order;
        return `
            <div class="stage">
                <div class="stage-dot ${dot}">${symbol}</div>
                <div class="stage-card" ${task ? `onclick="openTaskDetail(${task.id})" style="cursor:pointer"` : ''}>
                    <h4>${task ? esc(task.title) : `Stage ${stage.order}`}</h4>
                    ${task ? `<div class="assignee">${esc(task.assignee_name || 'Unassigned')}</div>
                    <div class="sla">${task.sla_hours}h SLA | ${task.deadline ? deadlineDisplay(task.deadline) : '-'}</div>
                    <div class="mt-8">${statusBadge(task.status)}</div>` : '<div class="assignee">Not started</div>'}
                </div>
            </div>
        `;
    }).join('');

    // Load activity for all tasks in this workflow
    const allActivity = [];
    for (const t of tasks) {
        const act = await api(`/api/tasks/${t.id}`);
        if (act && act.activity) allActivity.push(...act.activity.map(a => ({ ...a, task_title: t.title })));
    }
    allActivity.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

    document.getElementById('journeyActivityList').innerHTML = allActivity.slice(0,20).map(a => `
        <div class="activity-item">
            <span class="activity-time">${timeAgo(a.created_at)}</span>
            <span class="activity-action"><strong>${a.actor_name || 'System'}</strong> ${a.action} on <em>${a.task_title}</em></span>
        </div>
    `).join('') || '<p style="color:var(--text2)">No activity yet</p>';
}

function backFromJourney() {
    document.getElementById('journeyDetail').classList.add('hidden');
    if (journeyPrevView === 'domain') document.getElementById('domainDetail').classList.remove('hidden');
    else { document.getElementById('birdseyeMain').classList.remove('hidden'); }
}

// ==================== MY TASKS ====================
async function loadMyTasks() {
    const params = new URLSearchParams();
    const domain = document.getElementById('taskDomainFilter').value;
    const status = document.getElementById('taskStatusFilter').value;
    if (domain) params.set('domain', domain);
    if (status) params.set('status', status);

    const url = currentUser.isManager ? `/api/tasks?${params}` : `/api/tasks/mine?${params}`;
    const tasks = await api(url);

    if (taskViewMode === 'list') renderTaskList(tasks);
    else renderTaskKanban(tasks);
}

function renderTaskList(tasks) {
    document.getElementById('taskListView').classList.remove('hidden');
    document.getElementById('taskKanbanView').classList.add('hidden');

    document.getElementById('taskListView').innerHTML = tasks.map(t => `
        <div class="task-list-item" onclick="openTaskDetail(${t.id})">
            <div class="task-priority ${t.priority}"></div>
            <div class="task-info">
                <h4>${esc(t.title)}</h4>
                <div class="sub">${esc(t.assignee_name || 'Unassigned')} &middot; ${t.domain} ${t.entity_name ? '&middot; ' + esc(t.entity_name) : ''}</div>
            </div>
            <div class="task-steps">
                <div class="frac">${t.steps_completed}/${t.steps_total} steps</div>
                <div class="progress-bar mt-8"><div class="progress-fill" style="width:${t.steps_total?Math.round(t.steps_completed/t.steps_total*100):0}%;background:var(--green)"></div></div>
            </div>
            <div class="task-deadline">
                <div class="countdown" style="color:${deadlineColor(t.deadline, t.status)}">${t.deadline ? countdownText(t.deadline, t.status) : '-'}</div>
                <div class="date">${t.deadline ? formatDate(t.deadline) : ''}</div>
            </div>
            <div>${statusBadge(t.status)}</div>
        </div>
    `).join('') || '<div style="text-align:center;padding:40px;color:var(--text2)">No tasks found</div>';
}

function renderTaskKanban(tasks) {
    document.getElementById('taskListView').classList.add('hidden');
    document.getElementById('taskKanbanView').classList.remove('hidden');

    const cols = ['pending','assigned','in_progress','overdue','completed'];
    const colLabels = { pending:'Pending', assigned:'Assigned', in_progress:'In Progress', overdue:'Overdue', completed:'Completed' };

    document.getElementById('taskKanbanView').innerHTML = '<div class="kanban">' + cols.map(col => {
        const colTasks = tasks.filter(t => t.status === col);
        return `
            <div class="kanban-col">
                <div class="kanban-col-header">${colLabels[col]} <span class="count">${colTasks.length}</span></div>
                <div class="kanban-cards">
                    ${colTasks.map(t => `
                        <div class="kanban-card" onclick="openTaskDetail(${t.id})">
                            <h4>${esc(t.title)}</h4>
                            <div class="meta">
                                <span>${priorityBadge(t.priority)}</span>
                                <span>${t.deadline ? countdownText(t.deadline, t.status) : ''}</span>
                            </div>
                            <div class="meta mt-8"><span>${esc(t.assignee_name||'Unassigned')}</span><span>${t.steps_completed}/${t.steps_total}</span></div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('') + '</div>';
}

function setTaskView(mode, btn) {
    taskViewMode = mode;
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadMyTasks();
}

async function loadPersonalStats() {
    const stats = await api('/api/dashboard/my-stats');
    const onTimeRate = stats.tasks_completed > 0 ? Math.round((stats.tasks_on_time / stats.tasks_completed) * 100) : 0;
    document.getElementById('personalStats').innerHTML = `
        <div class="p-stat"><div class="val" style="color:var(--green)">${stats.tasks_completed || 0}</div><div class="lbl">Completed</div></div>
        <div class="p-stat"><div class="val" style="color:var(--blue)">${onTimeRate}%</div><div class="lbl">On-Time Rate</div></div>
        <div class="p-stat"><div class="val" style="color:var(--purple)">${stats.current_streak || 0}</div><div class="lbl">Current Streak</div></div>
        <div class="p-stat"><div class="val">${(stats.avg_completion_hours || 0).toFixed(1)}h</div><div class="lbl">Avg Completion</div></div>
    `;
}

// ==================== TASK DETAIL MODAL ====================
async function openTaskDetail(taskId) {
    const data = await api(`/api/tasks/${taskId}`);
    if (!data) return;

    document.getElementById('taskModalTitle').textContent = data.title;
    const isOwner = currentUser.isManager || (currentUser.employee_id && currentUser.employee_id === data.assignee_id);

    document.getElementById('taskModalBody').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            <div><strong>Domain:</strong> ${data.domain}</div>
            <div><strong>Priority:</strong> ${priorityBadge(data.priority)}</div>
            <div><strong>Status:</strong> ${statusBadge(data.status)}</div>
            <div><strong>SLA:</strong> ${data.sla_hours}h</div>
            <div><strong>Assignee:</strong> ${esc(data.assignee_name || 'Unassigned')}</div>
            <div><strong>Deadline:</strong> ${data.deadline ? formatDate(data.deadline) + ' (' + countdownText(data.deadline, data.status) + ')' : 'None'}</div>
            ${data.entity_name ? `<div><strong>Entity:</strong> ${esc(data.entity_name)}</div>` : ''}
            ${data.workflow_instance_id ? `<div><strong>Workflow:</strong> #${data.workflow_instance_id} <a href="#" onclick="showJourneyMap(${data.workflow_instance_id});closeModal('taskModal');return false" style="color:var(--blue)">View Journey</a></div>` : ''}
        </div>
        ${data.description ? `<div style="margin-bottom:16px;color:var(--text2);font-size:13px">${esc(data.description)}</div>` : ''}
        <h4 style="margin-bottom:8px">Checklist (${data.steps_completed}/${data.steps_total})</h4>
        <div class="progress-bar mb-16"><div class="progress-fill" style="width:${data.steps_total?Math.round(data.steps_completed/data.steps_total*100):0}%;background:var(--green)"></div></div>
        <ul class="checklist" id="taskChecklist">
            ${(data.steps||[]).map(s => `
                <li>
                    <button class="check-btn ${s.completed?'done':''}" ${s.completed || !isOwner ? 'disabled' : ''} onclick="completeStep(${data.id},${s.order})">${s.completed?'âœ“':''}</button>
                    <span style="${s.completed?'text-decoration:line-through;color:var(--text2)':''}">${esc(s.name)}</span>
                    ${s.completed_at ? `<span style="font-size:11px;color:var(--text2);margin-left:auto">${s.completed_by} - ${timeAgo(s.completed_at)}</span>` : ''}
                </li>
            `).join('')}
        </ul>
        <div class="btn-group" style="flex-wrap:wrap">
            ${data.status === 'pending' || data.status === 'assigned' ? `<button class="btn btn-primary btn-sm" onclick="startTaskAction(${data.id})">Start Task</button>` : ''}
            ${data.status !== 'completed' && data.status !== 'cancelled' && isOwner ? `<button class="btn btn-success btn-sm" onclick="completeTaskAction(${data.id})">Complete Task</button>` : ''}
            ${currentUser.isManager && data.status !== 'completed' && data.status !== 'cancelled' ? `<button class="btn btn-danger btn-sm" onclick="cancelTaskAction(${data.id})">Cancel</button>` : ''}
            ${currentUser.isManager && !data.assignee_id ? `<button class="btn btn-secondary btn-sm" onclick="showAssignUI(${data.id})">Assign</button>` : ''}
        </div>
        <div id="assignUI_${data.id}" class="hidden mt-16">
            <div class="form-row"><label>Assign to</label><select id="assignSelect_${data.id}"></select></div>
            <button class="btn btn-primary btn-sm" onclick="assignTaskAction(${data.id})">Confirm Assignment</button>
        </div>
        <h4 style="margin-top:20px;margin-bottom:8px">Activity</h4>
        <div>
            ${(data.activity||[]).map(a => `
                <div class="activity-item">
                    <span class="activity-time">${timeAgo(a.created_at)}</span>
                    <span class="activity-action"><strong>${a.actor_name||'System'}</strong> ${a.action}</span>
                </div>
            `).join('')}
        </div>
    `;

    openModal('taskModal');
}

async function completeStep(taskId, stepOrder) {
    await api(`/api/tasks/${taskId}/step/${stepOrder}`, 'POST');
    openTaskDetail(taskId);
}

async function startTaskAction(taskId) {
    await api(`/api/tasks/${taskId}/start`, 'POST');
    openTaskDetail(taskId);
    loadMyTasks();
}

async function completeTaskAction(taskId) {
    const notes = prompt('Completion notes (optional):');
    await api(`/api/tasks/${taskId}/complete`, 'POST', { notes });
    closeModal('taskModal');
    loadMyTasks();
    if (currentView === 'birdseye') loadBirdsEye();
}

async function cancelTaskAction(taskId) {
    const reason = prompt('Cancellation reason:');
    if (!reason) return;
    await api(`/api/tasks/${taskId}/cancel`, 'POST', { reason });
    closeModal('taskModal');
    loadMyTasks();
}

async function showAssignUI(taskId) {
    const el = document.getElementById(`assignUI_${taskId}`);
    el.classList.toggle('hidden');
    const employees = await api('/api/workflows/employees');
    const sel = document.getElementById(`assignSelect_${taskId}`);
    sel.innerHTML = employees.map(e => `<option value="${e.id}" data-name="${esc(e.employee_name)}">${esc(e.employee_name)} (${e.department})</option>`).join('');
}

async function assignTaskAction(taskId) {
    const sel = document.getElementById(`assignSelect_${taskId}`);
    const opt = sel.options[sel.selectedIndex];
    await api(`/api/tasks/${taskId}/assign`, 'POST', {
        assignee_id: sel.value,
        assignee_name: opt.dataset.name
    });
    openTaskDetail(taskId);
}

// ==================== CREATE TASK ====================
async function openCreateTask() {
    openModal('createTaskModal');
    const employees = await api('/api/workflows/employees');
    document.getElementById('ctAssignee').innerHTML = '<option value="">-- Unassigned --</option>' +
        employees.map(e => `<option value="${e.id}" data-name="${esc(e.employee_name)}">${esc(e.employee_name)} (${e.department})</option>`).join('');
}

async function createTask() {
    const sel = document.getElementById('ctAssignee');
    const opt = sel.options[sel.selectedIndex];
    const steps = document.getElementById('ctSteps').value.split('\n').filter(s=>s.trim());
    const data = {
        title: document.getElementById('ctTitle').value,
        description: document.getElementById('ctDesc').value,
        domain: document.getElementById('ctDomain').value,
        priority: document.getElementById('ctPriority').value,
        sla_hours: parseInt(document.getElementById('ctSLA').value) || 24,
        assignee_id: sel.value || null,
        assignee_name: sel.value ? opt.dataset.name : null,
        steps
    };
    await api('/api/tasks', 'POST', data);
    closeModal('createTaskModal');
    loadMyTasks();
}

// ==================== ADMIN: TEMPLATES ====================
async function loadTemplates() {
    const domain = document.getElementById('templateDomainFilter').value;
    const templates = await api(`/api/templates${domain ? '?domain=' + domain : ''}`);
    const tbody = document.querySelector('#templatesTable tbody');
    tbody.innerHTML = templates.map(t => `
        <tr>
            <td>${esc(t.name)}</td>
            <td>${domainBadge(t.domain)}</td>
            <td>${t.default_sla_hours}h</td>
            <td>${priorityBadge(t.priority)}</td>
            <td>${(t.steps||[]).length} steps</td>
            <td>${t.assignee_rule}${t.assignee_department ? ' ('+t.assignee_department+')' : ''}</td>
        </tr>
    `).join('');
}

async function openCreateTemplate() { openModal('createTemplateModal'); }

async function createTemplate() {
    const steps = document.getElementById('tplSteps').value.split('\n').filter(s=>s.trim());
    const data = {
        name: document.getElementById('tplName').value,
        description: document.getElementById('tplDesc').value,
        domain: document.getElementById('tplDomain').value,
        default_sla_hours: parseInt(document.getElementById('tplSLA').value) || 24,
        priority: document.getElementById('tplPriority').value,
        assignee_rule: document.getElementById('tplAssigneeRule').value,
        assignee_department: document.getElementById('tplDept').value || null,
        steps: steps.map((s,i) => ({ name: s, order: i+1 }))
    };
    await api('/api/templates', 'POST', data);
    closeModal('createTemplateModal');
    loadTemplates();
}

// ==================== ADMIN: WORKFLOWS ====================
async function loadWorkflowDefs() {
    const defs = await api('/api/workflows/definitions');
    const tbody = document.querySelector('#workflowDefsTable tbody');
    tbody.innerHTML = defs.map(d => `
        <tr>
            <td>${esc(d.name)}</td>
            <td>${domainBadge(d.domain)}</td>
            <td>${d.trigger_type}</td>
            <td>${(d.stages||[]).length} stages</td>
            <td>${esc(d.description||'')}</td>
        </tr>
    `).join('');

    // Also load for start workflow
    const sel = document.getElementById('startWfDef');
    sel.innerHTML = defs.map(d => `<option value="${d.id}">${d.name} (${d.domain})</option>`).join('');
    loadEntities();
}

async function loadEntities() {
    const type = document.getElementById('startWfEntityType').value;
    let entities = [];
    if (type === 'circuit') entities = await api('/api/dashboard/circuits');
    else if (type === 'lead') entities = await api('/api/dashboard/leads');
    else if (type === 'employee') entities = await api('/api/workflows/employees');
    else entities = [{ id: 'campaign-new', task_name: 'New Campaign', employee_name: 'New Campaign' }];

    const sel = document.getElementById('startWfEntity');
    sel.innerHTML = entities.map(e => `<option value="${e.id}">${esc(e.task_name || e.employee_name || e.id)}</option>`).join('');
}

async function startWorkflow() {
    const defId = document.getElementById('startWfDef').value;
    const entityType = document.getElementById('startWfEntityType').value;
    const entitySel = document.getElementById('startWfEntity');
    const entityOpt = entitySel.options[entitySel.selectedIndex];

    const result = await api('/api/workflows/start', 'POST', {
        definition_id: parseInt(defId),
        entity_type: entityType,
        entity_id: entitySel.value,
        entity_name: entityOpt ? entityOpt.textContent : ''
    });

    if (result && result.instance) {
        document.getElementById('startWfResult').innerHTML = `
            <div style="padding:12px;background:rgba(34,197,94,.1);border-radius:8px;color:var(--green)">
                Workflow started! Instance #${result.instance.id} with ${result.tasks.length} task(s) created.
                <a href="#" onclick="showView('birdseye');showJourneyMap(${result.instance.id});return false" style="color:var(--blue)"> View Journey â†’</a>
            </div>
        `;
    }
}

// ==================== ADMIN: PENALTIES ====================
async function loadPenalties() {
    const status = document.getElementById('penaltyStatusFilter').value;
    const penalties = await api(`/api/penalties${status ? '?status=' + status : ''}`);
    const tbody = document.querySelector('#penaltiesTable tbody');
    tbody.innerHTML = penalties.map(p => `
        <tr>
            <td>${esc(p.employee_name || p.employee_id)}</td>
            <td>${esc(p.task_title || '-')}</td>
            <td>${p.penalty_type}</td>
            <td style="font-weight:600;color:var(--red)">${p.amount}</td>
            <td>${statusBadge(p.status)}</td>
            <td>
                ${p.status === 'pending' ? `
                    <button class="btn btn-success btn-sm" onclick="approvePenalty(${p.id})">Approve</button>
                    <button class="btn btn-secondary btn-sm" onclick="waivePenalty(${p.id})">Waive</button>
                ` : (p.status === 'approved' ? `<span class="badge badge-green">Approved</span>` : `<span class="badge badge-gray">Waived</span>`)}
            </td>
        </tr>
    `).join('') || '<tr><td colspan="6" class="text-center" style="color:var(--text2)">No penalties</td></tr>';
}

async function approvePenalty(id) {
    const period = prompt('Payroll period (e.g. 2026-02):');
    await api(`/api/penalties/${id}/approve`, 'POST', { payroll_period: period });
    loadPenalties();
}

async function waivePenalty(id) {
    const notes = prompt('Reason for waiving:');
    if (!notes) return;
    await api(`/api/penalties/${id}/waive`, 'POST', { notes });
    loadPenalties();
}

// ==================== ADMIN: NOTIFICATIONS ====================
async function loadNotifications() {
    const notifs = await api('/api/dashboard/notifications?limit=50');
    const tbody = document.querySelector('#notificationsTable tbody');
    tbody.innerHTML = notifs.map(n => `
        <tr>
            <td>${timeAgo(n.created_at)}</td>
            <td>${esc(n.recipient_name||'-')}</td>
            <td>${n.message_type}</td>
            <td style="max-width:300px;white-space:pre-wrap;font-size:12px">${esc(n.message_text)}</td>
            <td>${statusBadge(n.status)}</td>
        </tr>
    `).join('') || '<tr><td colspan="5" class="text-center" style="color:var(--text2)">No notifications</td></tr>';
}

// ==================== ADMIN: LEADERBOARD ====================
async function loadLeaderboard() {
    const data = await api('/api/dashboard/leaderboard');
    const tbody = document.querySelector('#leaderboardTable tbody');
    tbody.innerHTML = data.map((e, i) => `
        <tr>
            <td>${i+1}</td>
            <td>${esc(e.employee_name||e.employee_id)}</td>
            <td style="font-weight:600">${e.tasks_completed}</td>
            <td style="color:${e.on_time_rate>=80?'var(--green)':e.on_time_rate>=50?'var(--yellow)':'var(--red)'}">${e.on_time_rate}%</td>
            <td>${e.current_streak}</td>
            <td>${(e.avg_completion_hours||0).toFixed(1)}h</td>
            <td style="color:var(--red)">${e.total_penalties||0}</td>
        </tr>
    `).join('') || '<tr><td colspan="7" class="text-center" style="color:var(--text2)">No data yet</td></tr>';
}

function showAdminSection(section, btn) {
    document.querySelectorAll('[id^="adminSection-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById('adminSection-' + section).classList.remove('hidden');
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    if (section === 'templates') loadTemplates();
    else if (section === 'workflows') loadWorkflowDefs();
    else if (section === 'penalties') loadPenalties();
    else if (section === 'notifications') loadNotifications();
    else if (section === 'leaderboard') loadLeaderboard();
    else if (section === 'startWf') loadWorkflowDefs();
}

// ==================== UTILS ====================
async function api(url, method = 'GET', body = null) {
    try {
        const opts = { method, headers: {} };
        if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
        const res = await fetch(url, opts);
        if (res.status === 401) { window.location.href = '/login.html'; return null; }
        return await res.json();
    } catch (e) { console.error('API error:', e); return null; }
}

function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function statusBadge(s) {
    const m = { pending:'badge-gray', assigned:'badge-blue', in_progress:'badge-purple', completed:'badge-green', cancelled:'badge-gray', overdue:'badge-red', blocked:'badge-orange', active:'badge-blue', paused:'badge-yellow', queued:'badge-gray', sent:'badge-green', failed:'badge-red', approved:'badge-green', waived:'badge-gray' };
    return `<span class="badge ${m[s]||'badge-gray'}">${(s||'').replace(/_/g,' ')}</span>`;
}

function priorityBadge(p) {
    const m = { urgent:'badge-red', high:'badge-orange', medium:'badge-blue', low:'badge-gray' };
    return `<span class="badge ${m[p]||'badge-gray'}">${p||''}</span>`;
}

function domainBadge(d) {
    const m = { sales:'badge-green', circuits:'badge-blue', marketing:'badge-purple', hr:'badge-orange' };
    return `<span class="badge ${m[d]||'badge-gray'}">${d||''}</span>`;
}

function formatDate(d) {
    if (!d) return '';
    return new Date(d).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

function timeAgo(d) {
    if (!d) return '';
    const s = Math.floor((Date.now() - new Date(d)) / 1000);
    if (s < 60) return 'just now';
    if (s < 3600) return Math.floor(s/60) + 'm ago';
    if (s < 86400) return Math.floor(s/3600) + 'h ago';
    return Math.floor(s/86400) + 'd ago';
}

function countdownText(deadline, status) {
    if (status === 'completed') return 'Done';
    if (status === 'cancelled') return 'Cancelled';
    const h = (new Date(deadline) - Date.now()) / 3600000;
    if (h <= 0) return Math.abs(h).toFixed(1) + 'h overdue';
    if (h < 1) return Math.round(h * 60) + 'm left';
    if (h < 24) return h.toFixed(1) + 'h left';
    return Math.floor(h / 24) + 'd ' + Math.round(h % 24) + 'h left';
}

function deadlineColor(deadline, status) {
    if (status === 'completed') return 'var(--green)';
    if (!deadline) return 'var(--text2)';
    const h = (new Date(deadline) - Date.now()) / 3600000;
    if (h <= 0) return 'var(--red)';
    if (h < 8) return 'var(--orange)';
    if (h < 24) return 'var(--yellow)';
    return 'var(--green)';
}

function deadlineDisplay(d) {
    const h = (new Date(d) - Date.now()) / 3600000;
    if (h <= 0) return `<span style="color:var(--red)">${formatDate(d)}</span>`;
    return formatDate(d);
}

function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
    el.addEventListener('click', e => { if (e.target === el) el.classList.remove('show'); });
});

// Init
init();
</script>
</body>
</html>
